# OpenZFS 加密功能在 FreeBSD 中上线

- 原文链接：[OpenZFS Encryption Arrives on FreeBSD](https://freebsdfoundation.org/wp-content/uploads/2020/07/OpenZFS-Encryption-Arrives-on-FreeBSD.pdf)
- 作者：**ALLAN JUDE & KYLE KNEISL**

在 FreeBSD 上的 OpenZFS 引入的新功能之一是巧妙地实现了行业标准的加密功能，作用于数据集级别。实际上，这意味着之前由 GELI 主导的 FreeBSD 存储加密生态系统，现在迎来了一个新的竞争者：OpenZFS 的“本地加密”功能。在本文中，我们将从技术和可用性角度讨论它与 GELI 的比较，帮助您评估在这两种加密解决方案中，您更倾向于选择哪一个（剧透：大多数情况下，选择新的那个）。

## GELI

GELI 已经成为 FreeBSD 主要的本地全盘加密系统有一段时间了。GELI 使用 AES（通常是 AES-256，采用 XTS 或 CBC 模式，这两种模式特别适用于磁盘数据加密），并配合使用 SHA-256 哈希（与比特币所使用的哈希相同）和消息认证。为此，GELI 利用 FreeBSD 的 crypto(9) 子系统提供硬件卸载，从而大大加速支持 AES-NI 或其他加密加速的系统上的性能（基本上，任何更新的平台都支持）。

然而，GELI 与 ZFS 完全没有关系。GELI 对整个设备进行加密，或者在更精细的粒度下加密其上的一个分区。因此，在首次使用任何以这种方式保护的文件系统之前，相关的设备或分区必须先“解锁”。一旦解锁，底层文件系统将被识别并挂载，通常在系统运行期间都会保持挂载。解锁程序由主密钥和最多两个用户密钥控制，这些密钥涉及密钥文件和密码短语的使用。这个复杂的密钥集允许在不需要重新加密数据的情况下重新对 GELI 分区进行密钥管理（例如，在某个密钥泄露的情况下）。

集成在 FreeBSD 引导代码中，因此只有一个小的 freebsd-boot 分区是未加密的，里面包含足够的代码来提示输入 GELI 密钥密码短语、解密启动分区并从底层的 ZFS（或 UFS）文件系统读取引导加载程序或内核。这意味着，除了一小部分启动代码外，整个文件系统（以及相关磁盘上的每一个字节的数据）都是加密的。

如果系统管理员正确实施，GELI 使用强加密，并采用强模式，在数据密钥过度使用之前进行轮换，并在其实现中遵循现代安全实践的其他若干要素。因此，GELI 是一个安全的加密实现，采用了所有关键领域的最佳实践，并且将继续保持其安全性。

### 常规块指针

![](https://github.com/user-attachments/assets/b2b234e6-8fcf-4741-ad39-75af46424747)

```c
/*
 * 图例：
 *
 * vdev 虚拟设备 ID
 * offset 虚拟设备中的偏移
 * LSIZE 逻辑大小
 * PSIZE 物理大小（压缩后）
 * ASIZE 分配大小（包括 RAID-Z 校验和填充）
 * GRID RAID-Z 布局信息（保留供将来使用）
 * cksum 校验和函数
 * comp 压缩函数
 * G 并行块指示符
 * B 字节序（字节顺序）
 * D 去重
 * X 加密
 * E blkptr_t 包含嵌入数据
 * lvl 间接级别
 * type DMU 对象类型
 * phys 物理出生事务组（txg）当 dva[0] 被写入时；如果与逻辑出生 txg 相同，则为零
 * 注意，通常所有的 dva 都会在此 txg 中写入，但如果它们被设备移除而移动，则可能不同。
 * log. 逻辑出生事务组，表示块逻辑上出生的事务组
 * fill count 该块指针下非零块的数量
 * checksum[4] 该块指针描述的数据的 256 位校验和
 */
```

### 加密块指针

![](https://github.com/user-attachments/assets/5438e6da-bbfe-4495-9ed4-3b0c158644cb)

```c
/*
 * 图例：
 *
 * salt 用于生成加密密钥的盐值
 * IV1 96 位加密 IV 的前 64 位
 * X 块需要加密处理（设置为 1）
 * E blkptr_t 包含嵌入数据（设置为 0，见下文）
 * fill count 该块指针下非零块的数量（截断为 32 位）
 * IV2 加密 IV 的最后 32 位
 * checksum[2] 该块指针描述的数据的 128 位校验和
 * MAC[2] 该数据的 128 位消息认证码
 */
```

